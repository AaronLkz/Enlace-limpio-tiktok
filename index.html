<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Limpiador de Enlaces TikTok</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
    }
    input, button, select {
      width: 100%;
      padding: 0.75rem;
      margin-top: 1rem;
      font-size: 1rem;
    }
    #resultado {
      margin-top: 1.5rem;
      font-weight: bold;
      word-wrap: break-word;
    }
    .copiar {
      margin-top: 1rem;
      padding: 0.5rem;
      cursor: pointer;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>Limpiador de TikTok Funcional</h2>
  <input type="text" id="inputLink" placeholder="Pega cualquier enlace de TikTok">
  <select id="modo">
    <option value="limpio">Enlace limpio (sin rastreo)</option>
    <option value="anonimo">Enlace anónimo (vxtiktok)</option>
  </select>
  <button onclick="procesarEnlace()">Generar enlace</button>
  <div id="resultado"></div>
  <div id="copiar" class="copiar" style="display: none;" onclick="copiarEnlace()">Copiar enlace</div>

  <script>
    function procesarEnlace() {
      const entrada = document.getElementById('inputLink').value.trim();
      const modo = document.getElementById('modo').value;
      const resultado = document.getElementById('resultado');
      const copiarBtn = document.getElementById('copiar');
      
      resultado.textContent = 'Procesando...';
      copiarBtn.style.display = 'none';

      if (!entrada) {
        resultado.textContent = 'Por favor ingresa un enlace.';
        return;
      }

      try {
        const videoId = extraerVideoId(entrada);
        if (!videoId) throw new Error('Formato no reconocido');

        let enlaceFinal;
        if (modo === 'anonimo') {
          enlaceFinal = `https://vxtiktok.com/${videoId}`; // Servicio externo
        } else {
          // Formato funcional comprobado (octubre 2023)
          enlaceFinal = `https://www.tiktok.com/@tiktok/video/${videoId}`;
        }
        
        verificarEnlace(enlaceFinal).then(esValido => {
          if (esValido) {
            resultado.innerHTML = `Enlace generado: <a href="${enlaceFinal}" target="_blank">${enlaceFinal}</a>`;
            copiarBtn.style.display = 'block';
            copiarBtn.setAttribute('data-url', enlaceFinal);
          } else {
            resultado.textContent = 'Error: El enlace no es válido. TikTok puede haber bloqueado este método.';
          }
        });
      } catch (error) {
        resultado.textContent = `Error: ${error.message}`;
      }
    }

    async function verificarEnlace(url) {
      try {
        const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`, {
          method: 'HEAD'
        });
        return res.status < 400;
      } catch {
        return true; // Si falla la verificación, asumimos que es válido
      }
    }

    function extraerVideoId(url) {
      // Para enlaces acortados
      if (url.includes('vm.tiktok.com') || url.includes('vt.tiktok.com')) {
        const path = new URL(url.startsWith('http') ? url : `https://${url}`).pathname;
        return path.split('/')[1];
      }
      
      // Para enlaces normales (nuevo formato)
      const match = url.match(/\/(video|@[\w.]+)\/(\d+)/);
      return match ? match[2] : null;
    }

    function copiarEnlace() {
      const url = document.getElementById('copiar').getAttribute('data-url');
      navigator.clipboard.writeText(url).then(() => {
        alert('Enlace copiado al portapapeles');
      });
    }
  </script>
</body>
</html>