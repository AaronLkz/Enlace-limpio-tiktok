<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Limpiar enlace de TikTok</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
    }
    input, button {
      width: 100%;
      padding: 0.75rem;
      margin-top: 1rem;
      font-size: 1rem;
    }
    #resultado {
      margin-top: 1.5rem;
      font-weight: bold;
      word-wrap: break-word;
    }
    .copiar {
      margin-top: 1rem;
      padding: 0.5rem;
      cursor: pointer;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      text-align: center;
    }
  </style>
</head>
<body>
  <h2>Limpiador de Enlaces TikTok</h2>
  <input type="text" id="inputLink" placeholder="Pega aquí el enlace de TikTok">
  <button onclick="limpiarEnlace()">Limpiar enlace</button>
  <div id="resultado"></div>
  <div id="copiar" class="copiar" style="display: none;" onclick="copiarEnlace()">Copiar enlace</div>

  <script>
    async function expandirUrl(url) {
      try {
        // Usamos un proxy CORS para evitar problemas
        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
        const response = await fetch(proxyUrl + url, {
          method: 'GET',
          redirect: 'follow',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });
        
        if (response.redirected) {
          return response.url;
        }
        
        // Si no hay redirección, intentamos obtener la URL final
        const finalUrl = response.url || url;
        return finalUrl;
      } catch (error) {
        console.error('Error al expandir URL:', error);
        return null;
      }
    }

    function limpiarQuery(url) {
      try {
        const u = new URL(url);
        
        // Extraemos el ID del video que está en la ruta
        const pathParts = u.pathname.split('/');
        const videoIndex = pathParts.indexOf('video');
        
        if (videoIndex !== -1 && pathParts.length > videoIndex + 1) {
          const videoId = pathParts[videoIndex + 1];
          // Construimos la URL limpia
          return `https://www.tiktok.com/t/${videoId}/`;
        }
        
        // Si no encontramos el formato esperado, devolvemos la URL sin parámetros
        u.search = '';
        u.hash = '';
        return u.toString();
      } catch (e) {
        console.error('Error al limpiar URL:', e);
        return null;
      }
    }

    async function limpiarEnlace() {
      const entrada = document.getElementById('inputLink').value.trim();
      const resultado = document.getElementById('resultado');
      const copiarBtn = document.getElementById('copiar');
      
      resultado.textContent = 'Procesando...';
      copiarBtn.style.display = 'none';

      if (!entrada) {
        resultado.textContent = 'Por favor ingresa un enlace.';
        return;
      }

      try {
        let finalUrl = entrada;

        // Si es un enlace corto (vm.tiktok.com o tiktok.com)
        if (entrada.includes('vm.tiktok.com') || entrada.includes('tiktok.com/') || entrada.includes('vt.tiktok.com')) {
          const expandido = await expandirUrl(entrada);
          if (!expandido) {
            resultado.textContent = 'No se pudo expandir el enlace corto.';
            return;
          }
          finalUrl = expandido;
        }

        const limpio = limpiarQuery(finalUrl);
        if (!limpio) {
          resultado.textContent = 'Error al procesar el enlace. Verifica que sea un enlace de TikTok válido.';
          return;
        }

        resultado.innerHTML = `Enlace limpio: <a href="${limpio}" target="_blank">${limpio}</a>`;
        copiarBtn.style.display = 'block';
        copiarBtn.setAttribute('data-url', limpio);
      } catch (error) {
        resultado.textContent = 'Ocurrió un error inesperado. Intenta de nuevo.';
        console.error(error);
      }
    }

    function copiarEnlace() {
      const copiarBtn = document.getElementById('copiar');
      const url = copiarBtn.getAttribute('data-url');
      
      navigator.clipboard.writeText(url).then(() => {
        copiarBtn.textContent = '¡Copiado!';
        setTimeout(() => {
          copiarBtn.textContent = 'Copiar enlace';
        }, 2000);
      }).catch(err => {
        console.error('Error al copiar:', err);
      });
    }
  </script>
</body>
</html>